{% extends "layout.html" %}

{% block title %}Blockchain Dashboard{% endblock %}

{% block content %}
<div class="card">
    <h2>Blockchain Explorer</h2>
    
    <!-- Quick Actions Toolbar -->
    <div class="card" style="margin-bottom: 1rem;">
        <h3>Quick Actions</h3>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="{{ url_for('home') }}" class="btn">View Databases</a>
            {% if session.role == 'admin' %}
            <a href="{{ url_for('create_database') }}" class="btn">Create Database</a>
            {% endif %}
            <a href="{{ url_for('blockchain_dashboard') }}" class="btn">Refresh Dashboard</a>
        </div>
    </div>

    <!-- Chain Status Card -->
    <div class="card" style="margin-bottom: 1rem;">
        <h3>Chain Status</h3>
        <div id="chain-status">
            <p>Loading blockchain data...</p>
        </div>
        <button id="refresh-btn" class="btn">Refresh Data</button>
    </div>

    <!-- Block List -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Blocks</h3>
            <div>
                <button id="view-raw-chain" class="btn" style="margin-left: 1rem;">View Raw Chain</button>
            </div>
        </div>
        <div id="blocks-container">
            <table id="blocks-table">
                <thead>
                    <tr>
                        <th>Index</th>
                        <th>Timestamp</th>
                        <th>Hash</th>
                        <th>Data</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="blocks-list">
                    <!-- Blocks will be populated via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Block Detail Modal -->
<div id="block-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Block Details</h3>
        <pre id="block-details"></pre>
    </div>
</div>

<!-- Raw Chain Modal -->
<div id="raw-chain-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 1200px;">
        <span class="close">&times;</span>
        <h3>Raw Blockchain Data</h3>
        <pre id="raw-chain-data"></pre>
    </div>
</div>

<script>
    // Fetch blockchain data from API
    async function fetchBlockchainData() {
        try {
            const [chainRes, statusRes] = await Promise.all([
                fetch('/api/chain'),
                fetch('/api/status')
            ]);
            
            const chain = await chainRes.json();
            const status = await statusRes.json();
            
            // Update chain status
            document.getElementById('chain-status').innerHTML = `
                <p><strong>Status:</strong> <span class="${status.status === 'healthy' ? 'success' : 'error'}">
                    ${status.status.toUpperCase()}
                </span></p>
                <p><strong>Length:</strong> ${status.chain_length} blocks</p>
                <p><strong>Latest Block Hash:</strong> <span class="monospace">${status.latest_block.hash.substring(0, 24)}...</span></p>
            `;
            
            // Populate blocks table
            const blocksList = document.getElementById('blocks-list');
            blocksList.innerHTML = chain.map(block => `
                <tr>
                    <td>${block.index}</td>
                    <td>${new Date(block.timestamp * 1000).toLocaleString()}</td>
                    <td class="monospace">${block.hash.substring(0, 16)}...</td>
                    <td>${getDataPreview(block.data)}</td>
                    <td><button onclick="showBlockDetails(${block.index})" class="btn">View</button></td>
                </tr>
            `).join('');
            
        } catch (error) {
            console.error('Failed to fetch blockchain data:', error);
            document.getElementById('chain-status').innerHTML = 
                '<p class="error">Failed to load blockchain data.</p>';
        }
    }

    // Helper function to format data preview
    function getDataPreview(data) {
        if (data.action === 'create_database') {
            return `Create DB: ${data.name}`;
        } else if (data.action === 'store_item') {
            return `Store: ${data.item_name} in ${data.database}`;
        }
        return JSON.stringify(data).substring(0, 50) + '...';
    }

    // Show block details in modal
    function showBlockDetails(index) {
        fetch(`/api/chain`)
            .then(res => res.json())
            .then(chain => {
                const block = chain[index];
                document.getElementById('block-details').textContent = 
                    JSON.stringify(block, null, 2);
                document.getElementById('block-modal').style.display = 'block';
            });
    }

    // Show raw chain data
    document.getElementById('view-raw-chain').addEventListener('click', () => {
        fetch('/api/chain')
            .then(res => res.json())
            .then(data => {
                document.getElementById('raw-chain-data').textContent = 
                    JSON.stringify(data, null, 2);
                document.getElementById('raw-chain-modal').style.display = 'block';
            });
    });

    // Close modals
    function setupModalClose() {
        document.querySelectorAll('.modal .close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        window.addEventListener('click', (event) => {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        });
    }

    // Refresh data button
    document.getElementById('refresh-btn').addEventListener('click', fetchBlockchainData);

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        fetchBlockchainData();
        setupModalClose();
    });
</script>

<style>
    .monospace { font-family: monospace; }
    .success { color: green; }
    .error { color: red; }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 1.5rem;
        width: 80%;
        max-width: 800px;
        border-radius: 5px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .modal-content pre {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .close {
        float: right;
        font-size: 1.5rem;
        cursor: pointer;
        margin-left: 1rem;
    }
    
    /* Quick actions toolbar */
    .quick-actions {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}